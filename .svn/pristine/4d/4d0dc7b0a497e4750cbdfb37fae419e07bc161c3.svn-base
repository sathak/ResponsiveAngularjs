(function (navcon) {
    navcon.kendo.tree = {
        columnSetting: function (settings, scope) {
            var items = [];
            $.each(settings.columns, function (i, item) {
                item.field = item.data;
                if (item.visible !== undefined && item.visible !== "") item.hidden = !item.visible;

                if (item.type !== undefined && item.type.toLowerCase() === "select") {
                    //item.editor = navcon.kendo.tree.editDropDown;
                    item.editor = jQuery.proxy(navcon.kendo.tree.editDropDown, { option: { id: item.data, text: item.data }, dataset: settings });

                    item.template = "#=" + item.data + "#";

                    if (item.filterable === undefined || item.filterable) {
                        item.filterable = {
                            cell: {
                                template: function (args) {
                                    args.element.kendoDropDownList({
                                        dataSource: navcon.kendo.tree.distinctData(args.dataSource.options.data, item.data),
                                        dataTextField: item.data,
                                        dataValueField: item.data,
                                        valuePrimitive: true,
                                        optionLabel: "--Select " + item.title + "--"
                                    });
                                },
                                showOperators: false,
                                operator: "contains"
                            },
                            ui: function (element) {
                                //navcon.kendo.tree.filterDropDown(element, item.data, settings);
                                jQuery.proxy(navcon.kendo.tree.filterDropDown, { option: { id: item.data, text: item.data }, dataset: settings });
                            }
                        };
                    }
                } else if (item.type !== undefined && item.type.toLowerCase() === "date") {
                    item.template = "#= kendo.toString(kendo.parseDate(" + item.data + "), '" + navcon.defaultFormat().kdate + "')#";

                    if (item.filterable === undefined || item.filterable) {
                        item.filterable = {
                            cell: {
                                showOperators: false,
                                operator: "contains"
                            },
                            ui: "datetimepicker" // use Kendo UI DateTimePicker
                            //element.kendoDateTimePicker(); // initialize a Kendo UI DateTimePicker
                        };
                    }
                } else if (item.type !== undefined && item.type.toLowerCase() === "autoselect") {
                    if (item.filterable === undefined || item.filterable) {
                        item.filterable = {
                            cell: {
                                inputWidth: "100%",
                                showOperators: true,
                                operator: "contains",
                                suggestionOperator: "contains"
                            }
                        };
                    }
                } else {
                    if (item.type !== undefined && item.type !== "") item.type = "string";
                    if (item.filterable === undefined || item.filterable) {
                        item.filterable = {
                            cell: {
                                operator: "contains",
                                suggestionOperator: "contains"
                            }
                        };
                    }

                    /*item.editor= function (container, options) {
                        var input = $("<input/>");
                        input.attr("name", options.field);
                        input.attr("placeholder", "(optional)");
                        input.appendTo(container);
                    }*/
                }

                if (settings.options !== undefined && settings.options.editree !== undefined && settings.options.editree.enabled !== undefined
                    && !settings.options.editree.enabled && item.command !== undefined && item.command.length !== 0) return false;

                items.push(item);
            });

            return items;
        },
        rowSetting: function (settings, scope) {
            var dataSource = new kendo.data.HierarchicalDataSource({
                data: [
                  {
                      id: 1, text: "Item 1", dept: "", owner: "", expanded: true, rowLevel: 1, items: [
                      { id: 2, text: "Item 2", dept: "Benefits", owner: "Bob", rowLevel: 2 },
                      {
                          id: 3, text: "Item 3", dept: "Loans", owner: "Suzy", rowLevel: 2, expanded: true, items: [
                          { id: 4, text: "Item 4", dept: "Accounting", owner: "John", rowLevel: 3 },
                          { id: 5, text: "LongItem 5", dept: "Marketing", owner: "Alice", rowLevel: 3 }
                          ]
                      },
                      { id: 6, text: "LongItem 6", dept: "Loans", Owner: "Andy", rowLevel: 2 }
                      ]
                  }]
            });

            //var items = [];
            //items = settings.data;

            //var fieldsConfig = scope.fields[0];
            //var field = { "primaryKey": "Id" };
            //var fieldConfigIndex = navcon.getItemIndexByProperty(scope.fields, "fieldConfig");
            //if (fieldConfigIndex !== undefined && fieldConfigIndex !== -1) field = scope.fields[fieldConfigIndex];

            //var dataSource = new kendo.data.DataSource({
            //    type: "odata",
            //    data: items,
            //    pageSize: settings.pageLength !== undefined ? settings.pageLength : 20,
            //    batch: true,
            //    schema: {
            //        model: {
            //            id: (settings.options !== undefined && settings.options.primaryKey !== undefined ? settings.options.primaryKey : field.primaryKey),
            //            fields: navcon.kendo.tree.validationSchema(settings, scope),
            //        }
            //    }
            //});

            return dataSource;
        },
        setting: function (el, options, scope) {
            var settings = {};
            if (options != undefined && options.options !== undefined) settings = options.options;

            var oTree = null;
            var tree = $($(el).find('.kendoTree')[0]);
            if (tree !== undefined && tree !== null) {
                //var scope = $(tree).scope();

                kendo.destroy(tree);
                tree.empty();

                var treeDatasource = navcon.kendo.tree.rowSetting(options, scope);

                var oTree = tree.kendoTreeView({
                    type: $(el).attr("type"),
                    dataSource: treeDatasource,
                    template: kendo.template($("#treeview-template").html()),
                    dragAndDrop: true,
                }).data("kendoTreeView");
            }

            var dataservice = angular.element(document).injector().invoke(function (dataservice) { return dataservice; });
            var logger = angular.element(document).injector().invoke(function (logger) { return logger; });
            var toolbarOptions = [];

            if (oTree !== undefined && oTree !== null) {
                //Selectree Settings

                //PDF settings
                if (settings.pdf !== undefined && settings.pdf.enabled !== undefined && settings.pdf.enabled) {
                    toolbarOptions.push({ name: "pdf", text: "Export PDF", iconClass: "k-icon k-i-print" });

                    oTree.setOptions({
                        //toolbar: [{ name: "pdf", text: "Export PDF", iconClass: "k-icon k-i-copy" }],
                        pdf: {
                            allPages: true,
                            avoidLinks: true,
                            paperSize: "A4",
                            margin: { top: "2cm", right: "1cm", bottom: "1cm", left: "1cm" },
                            landscape: true,
                            repeatHeaders: true,
                            fileName: $(el).attr("type") + ".pdf",
                            template: $("#print-template").html(),
                            scale: 0.8
                            /*subject: "Products",
                            title: "Products",
                            fileName: "Products.pdf",
                            keywords: "northwind products",
                            author: "Navcon",
                            creator: "Navcon",
                            avoidLinks: true,
                            date: navcon.getCurrentDate,
                            paperSize: ["20mm", "20mm"],
                            landscape: true,
                            margin: {
                                left: 10,
                                right: "10pt",
                                top: "10mm",
                                bottom: "1in"
                            },
                            forceProxy: true,
                            proxyURL: "/save",
                            proxyTarget: "_blank",*/
                        },
                        pdfExport: function (e) {
                            title = $(el).attr("type");
                            date = navcon.getCurrentDate();

                            oTree.hideColumn(4);

                            e.promise.done(function () {
                                oTree.showColumn(4);
                            });
                        }
                    });
                }

                //Toolbar  options
                if (toolbarOptions !== undefined && toolbarOptions.length !== 0) {
                    //toolbarOptions.push("<p>My string template in a paragraph.</p>");
                    //toolbarOptions.push(kendo.template("<p>My function template.</p>"));
                    //toolbarOptions.push({ template: '<a class="k-button" href="\\#" onclick="return toolbar_click()">Command</a>' });
                    //toolbarOptions.push({ template: kendo.template($("#toolbar-template").html()) }); //toolbar template

                    oTree.setOptions({
                        toolbar: toolbarOptions
                    });

                    if (settings.editree !== undefined && settings.editree.createAt !== undefined && settings.editree.createAt.toLowerCase() === "bottom") {
                        $(".k-grid-toolbar").insertAfter($(".k-grid-pager").length !== 0 ? $(".k-grid-pager") : $(".k-grid-content"));
                    }

                    $(".k-grid-pdf").css("float", "right");
                }
            }

            //cell click 
            $(tree).find('tbody').on('click', 'td', function (el, tt) {
                //var treeSettings = scope.treeSettings;
                //var tr = $(this).closest("tr");

                //var treeData = oTree.dataSource.data();
                //var rowId = tr.attr("data-uid");
                //var selectedRowIndex = navcon.save.selectedRowIndex(treeData, { "uid": rowId }, "uid");

                //var rowData = treeData[selectedRowIndex];
                //var rowIndex = selectedRowIndex;
                //var rowObj = tr;

                //var cellData = $(this).text();
                //var columnIndex = rowObj.find(this).index();
                //var cellObj = this;
                //var columnTitle = treeSettings.columns[columnIndex].title;

                //scope.fields.mode = "View";

                ////if (scope.navconData.rights !== undefined && ((!scope.navconData.rights.Add && columnTitle === "add") || (!scope.navconData.rights.Edit && columnTitle === "edit")
                ////    || ((!scope.navconData.rights.View && !scope.navconData.rights.Approve) && columnTitle === "view") || (!scope.navconData.rights.Delete && columnTitle === "delete"))) return false;

                ////if (scope.treeSettings.treeCellClick !== undefined) {
                //var approveAnchor = $(this).find("a.gridApprove");
                //if (approveAnchor !== undefined && approveAnchor !== null && approveAnchor.length !== 0) {
                //    var action = "Approve";
                //    if (scope.navconData.treeRowApproveClick === undefined) return;
                //    scope.navconData.treeRowApproveClick(rowIndex, columnIndex, rowData, scope.type, this, oTree, action);
                //} else {
                //    if (scope.navconData.treeCellClick === undefined) return;
                //    scope.navconData.treeCellClick(rowIndex, columnIndex, rowData, scope.type, this, oTree, undefined, action);
                //}
                ////}
            });

            //});
        },
        refresh: function (el, setting, scope) {
            if (setting.data.length === 0) setting.data = [];
            navcon.kendo.tree.setting(el, setting, scope);

            //var tree = $($(el).find('tree')[0]);
            //var tabInst = tree.Datatree.fntrees();
            //if ($(tabInst).parents("navcon-tree[type='" + $(el).attr("type") + "']").length === 0 || tree.children().length === 0) {
            //    navcon.kendo.tree.setting(el, setting, scope);
            //    return;
            //}
            //var oTree = tree.Datatree();
            //oTree.clear();

            //oTree.rows.add(setting.data).draw();

            //var tree = $($(el).find('.kendoGrid')[0]);
            //var grid = tree.data("kendoGrid");
            /*var items = navcon.kendo.tree.rowSetting(setting.data);
            grid.dataSource.data(items);*/

            //tree.find(".k-grid-content").css('max-height', '500px');
            //tree.find(".k-filtercell>span[style='width: 100%;']").css("display", "");
            //tree.find(".k-filtercell, .k-filtercell .k-widget, .k-filtercell>span[style='width: 100%;']").css("display", "");
        },
        selectedRowIndex: function (tree, selectedRow, idColumn) {
            var returnData = -1;
            var treeData = tree.data !== undefined ? tree.data : tree;

            if (treeData !== undefined && treeData.length > 0)
                returnData = navcon.getItemIndexByKeyValue(treeData, idColumn, selectedRow[idColumn]);

            return returnData;
        },
        pdfExport: function (kendoTree, settings, e) {
            var progress = $.Deferred();

            /*kendo.drawing.drawDOM($("#header"))
              .done(function(header) {
                  kendo.drawing.drawDOM($("#footer"))
                    .done(function(footer) {*/
            kendoTree._drawPDF(progress)
              .then(function (root) {
                  root.children.unshift(header);
                  root.children.push(footer);

                  return kendo.drawing.exportPDF(root, {
                      paperSize: "auto",
                      margin: { left: "1cm", top: "1cm", right: "1cm", bottom: "1cm" },
                      multiPage: true
                  });
              })
              .done(function (dataURI) {
                  //console.log("Okay");
                  kendo.saveAs({
                      dataURI: dataURI,
                      fileName: "navcon.pdf"
                  });
                  progress.resolve();
              })
            /*});
        })*/
        },
        validationSchema: function (settings, scope) {
            var myFields = {};
            var strFields = "";

            $.each(settings.columns, function (i, item) {
                var type = item.type;
                var fieldTitle = item.title;
                var fieldName = item.data;

                var fieldKey = item.fieldKey;
                var field = null;
                var fieldKeyIndex = navcon.getItemIndexByProperty(scope.fields, fieldKey);
                if (fieldKeyIndex !== undefined && fieldKeyIndex !== -1) field = scope.fields[fieldKeyIndex];

                if (fieldName !== undefined && fieldName !== null && fieldName !== "") {
                    myFields[fieldName] = { "validation": {} };

                    if (fieldName !== undefined && fieldName !== null && fieldName !== "" && fieldName.length !== 0) {
                        if (type !== undefined && type.toLowerCase() === "autoselect") type = "string";
                        myFields[fieldName].validation["type"] = type;

                        if (field !== undefined && field !== null && field.templateOptions !== undefined && field.templateOptions.length !== 0) {
                            var validation = field.templateOptions;
                            //Required message
                            navcon.kendo.requiredValidation(myFields[fieldName], fieldName, validation);
                            /*if (validation.required !== undefined && validation.required !== null && (validation.required || validation.required.toLowerCase() === "yes")) {
                                if (validation.requiredMessage !== undefined && validation.requiredMessage !== null && validation.requiredMessage !== "")
                                    myFields[fieldName].validation["required"] = { "message": validation.requiredMessage };
                                else
                                    myFields[fieldName].validation["required"] = (validation.required || validation.required.toLowerCase() === "yes" ? true : false);
                            }*/

                            //Minium message
                            navcon.kendo.minimumValidation(myFields[fieldName], fieldName, validation);
                            /*if (validation.minlength !== undefined && validation.minlength !== null && validation.minlength !== "") {
                                var messageMin = validation.minlengthMessage !== undefined && validation.minlengthMessage !== "" ? validation.minlengthMessage : "Minimum " + validation.minlength + " character required.";
                                myFields[fieldName].validation[fieldName.toLowerCase() + "min"] = function (input) {
                                    if (input.is("[name='" + fieldName + "']") && input.val().length < validation.minlength) {
                                        input.attr("data-" + fieldName.toLowerCase() + "min-msg", "" + validation.minlengthMessage + "");
                                        return false;
                                    }
                                    return true;
                                }
                            }*/

                            //Maximum message
                            navcon.kendo.maximumValidation(myFields[fieldName], fieldName, validation);
                            /*if (validation.maxlength !== undefined && validation.maxlength !== null && validation.maxlength !== "") {
                                var messageMin = validation.maxlengthMessage !== undefined && validation.maxlengthMessage !== "" ? validation.maxlengthMessage : "Maximum " + validation.maxlength + " only allowed.";
                                myFields[fieldName].validation[fieldName.toLowerCase() + "max"] = function (input) {
                                    if (input.is("[name='" + fieldName + "']") && input.val().length > validation.maxlength) {
                                        input.attr("data-" + fieldName.toLowerCase() + "max-msg", "" + validation.maxlengthMessage + "");
                                        return false;
                                    }
                                    return true;
                                }
                            }*/

                            //Pattern message
                            navcon.kendo.patternValidation(myFields[fieldName], fieldName, validation);
                            /*if (validation.pattern !== undefined && validation.pattern !== null && validation.pattern !== "") {
                                var patternRegex = new RegExp(validation.pattern.toString());
                                var messageMin = validation.patternMessage !== undefined && validation.patternMessage !== "" ? validation.patternMessage : "Alpha numeric only allowed.";
                                myFields[fieldName].validation[fieldName.toLowerCase() + "pattern"] = function (input) {
                                    if (input.is("[name='" + fieldName + "']") && input.val() != "") {
                                        input.attr("data-" + fieldName.toLowerCase() + "pattern-msg", "" + validation.patternMessage + "");
                                        return patternRegex.test(input.val());
                                    }
                                    return true;
                                }
                            }*/

                            //ExistData message
                            navcon.kendo.existDataValidation(myFields[fieldName], fieldName, validation, scope);
                            /*if (validation.isExistData !== undefined && validation.isExistData !== null && validation.isExistData !== "") {
                                var scopeData = scope.navconData[validation.isExistData];
                                var keyOldData = "";

                                var messageMin = validation.isExistMessage !== undefined && validation.isExistMessage !== "" ? validation.isExistMessage : "already exists..";
                                myFields[fieldName].validation[fieldName.toLowerCase() + "exists"] = function (input) {
                                    if (input.is("[name='" + fieldName + "']") && input.val() != "") {
                                        if (scope.fields.getById !== undefined && scope.fields.getById !== null)
                                            keyOldData = scope.fields.getById[fieldKey];

                                        retVal = navcon.getItemByKeyValue(scopeData, fieldKey, input.val().toString().trim());
                                        if (retVal !== -1 && input.val().toString().trim() !== keyOldData.toString().trim()) {
                                            input.attr("data-" + fieldName.toLowerCase() + "exists-msg", "" + validation.isExistMessage + "");
                                            retVal = false;
                                        }
                                        else
                                            retVal = true;

                                        return retVal;
                                    }
                                    return true;
                                }
                            }*/
                        }
                    }
                }
            });

            return myFields;
        }
    }
}(navcon || {}));